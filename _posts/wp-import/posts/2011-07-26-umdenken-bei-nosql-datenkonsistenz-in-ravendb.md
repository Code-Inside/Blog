---
layout: post
title: "Umdenken bei NOSQL: Datenkonsistenz in RavenDB"
date: 2011-07-26 00:22
author: robert.muehsig
comments: true
categories: [Allgemein]
tags: [NoSQL, RavenDB]
---
{% include JB/setup %}
<p>Bereits im <a href="{{BASE_PATH}}/2011/07/05/nosql-mit-ravendb-und-asp-net-mvc/">Einstiegspost</a> wurden auf die Vor- aber auch auf die Nachteile von einer NoSQL Datenbank (in meinem Fall RavenDB) eingegangen. Die größte gedankliche Hürde ist das die Datenkonsistenz nicht so einfach sicherzustellen ist, wie in einer klassischen Datenbank.</p> <p><em>Ich sprech jetzt mal von RavenDB, weil ich nicht wirklich weiß ob dies bei anderen NoSQL Datenbanken ähnlich ist. Falls ich bei dem geschriebenen auf dem Holzweg bin, sagt mir einfach Bescheid <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-winkingsmile" alt="Zwinkerndes Smiley" src="{{BASE_PATH}}/assets/wp-images/wlEmoticon-winkingsmile6.png"></em></p> <p><strong>Wo liegt das Problem?</strong></p> <p>In einer klassischen Datenbank kann ich Verknüpfungen zwischen Tabelleneinträgen herstellen. Der heilige Gral der Schulweisheit ist eine <a href="http://de.wikipedia.org/wiki/Normalisierung_(Datenbank)#Dritte_Normalform_.283NF.29">Datenbank in der 3. Normalform</a>. Beispiel: Ein Kunde macht Bestellungen und kauft dabei ein Produkt.</p> <p>In Tabellenform gedacht hätten wir nun eine Kunden-Tabelle, eine Produkt-Tabelle und eine Bestellung-Tabelle mit der Referenz zum Kunden und zu einem Produkt. Das Beispiel kann man noch beliebig aufblähen und kennt wahrscheinlich jeder <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-winkingsmile" alt="Zwinkerndes Smiley" src="{{BASE_PATH}}/assets/wp-images/wlEmoticon-winkingsmile6.png"></p> <p><strong>Es gibt kein Schema…</strong></p> <p>In RavenDB ist es etwas anders. Dort gibt es keine direkten Verknüpfungen zwischen Dokumenten. Jedes Dokument steht für sich alleine. Siehe auch dieses Bild:</p> <p><img alt="image" src="{{BASE_PATH}}/assets/wp-images/image_thumb471.png"></p> <p>In der RavenDB Doku ist <a href="http://ravendb.net/documentation/docs-document-design"><strong>dieser Abschnitt dazu</strong></a> besonders interessant und für Einsteiger <u>empfehlenswert</u>. Natürlich gibt es auch hier “Verbindungen”, allerdings sind diese hier deutlich weicher als in einer klassischen Datenbank. Unter “blogs/9431” gibt es die Verbindung zu dem “users/ayende” Dokument, jedoch lädt RavenDB nicht automatisch irgendwelche Daten nach. Dieses Verhalten kennt man von diversen ORMs, welche über User.Orders.Products.First() witzige SQL Statements erzeugen und die Datenbank unter Last setzt <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-winkingsmile" alt="Zwinkerndes Smiley" src="{{BASE_PATH}}/assets/wp-images/wlEmoticon-winkingsmile6.png"></p> <p><strong>Hat man dadurch nicht Daten doppelt?</strong></p> <p>Hier fängt meine “gedankliche Blockade” an - jedoch ist die doppelte Datenhaltung in diesem Fall beabsichtig: Daten sollen doppelt gehalten werden. Wenn wir die Tags und Kategorien an einem Post brauchen um diesen im Frontend darzustellen, dann hängen wir diese Daten da auch mit ran.</p> <p>(Natürlich kann man solche Sachen auch mit klassischen Datenbanken machen und Daten doppelt vorhalten oder “cachen” – allerdings macht man dies meist aus Performancegründen und nicht weil es so schön elegant ist <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-winkingsmile" alt="Zwinkerndes Smiley" src="{{BASE_PATH}}/assets/wp-images/wlEmoticon-winkingsmile6.png">) </p> <p><strong>Updateszenarien</strong></p> <p>Schwierig wird es natürlich nun wenn ich eine Kategorie komplett umbenennen will. In diesem Fall muss man wohl über alle Posts gehen und schauen ob die Kategorie noch dran ist. <a href="{{BASE_PATH}}/assets/wp-images/image1300.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; float: left; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" align="left" src="{{BASE_PATH}}/assets/wp-images/image_thumb482.png" width="157" height="160"></a></p> <p>An dieser Stelle muss man natürlich entscheiden: Macht es Sinn die Kategorien überall umzubenennen? Wenn wir das Kunde/Bestellsystem Beispiel von oben nehmen: Der Kunde kauft zum Zeitpunkt A ein Produkt namens “Nimbus 2000”. Nun ändere ich zum Zeitpunkt B aber den Namen des Produkt in “Nimbus 2010”. Jetzt sieht es allerdings in der Datenbank so aus als hätte der Kunde den “Nimbus 2010” gekauft. Interessanter wird es noch, wenn ich das Produkt löschen möchte…</p> <p>Zum Teil macht es auch extrem Sinn die Daten “doppelt” zu halten. Nicht nur von der Performance, sondern auch vom fachlichen.</p> <p>&nbsp;</p> <p><strong>Was passiert wenn ich ein Feld hinzufüge oder entferne? Wie behalte ich da die Kontrolle?</strong></p> <p>Diese Frage kam vorhin bei <a href="http://twitter.com/#!/goloroden">Golo Roden</a> auf. Was passiert, wenn ich nun zu einem Produkt noch zusätzliche Daten abspeichern möchte? Oder ich möchte ein bestimmtes Merkmal nicht mehr speichern? Wie geht RavenDB damit um?</p> <p>Um es mal einfach zu sagen: RavenDB ist es egal – es serialisiert am Ende nur Objekte als JSON. Alle Daten eines Dokumentes sind als JSON abgespeichert. Da gibt es kein Schema. Wenn ein Property hinzukommt, dann wird es beim Serialisieren berücksichtig. Wenn ich auf “leere” oder “nicht vorhandene” Felder zugreifen möchte bekomme ich in RavenDB einfach ein<strong> leeres Objekt</strong> zurück. In diesem Fall muss ich mich <strong>in der Applikation</strong> darum kümmern.</p> <p>Wenn ein Property entfernt wird, dann wird es im Prinzip auch ignoriert und beim nächsten Speichern wird es auch entfernt – weil das Property nicht mehr vorhanden ist und die alten Daten überschrieben werden. </p> <p>Schwieriger wird es wenn Properties umbenannt werden, aber auch gibt es ein Extension Point.</p> <p>Wer vor diesen Problemen steht, sollte nochmal ein Blick auf diesen Blogpost von Ayende werfen:</p> <p><a href="http://ayende.com/blog/66563/ravendb-migrations-rolling-updates?key=4e0308d753ea4144ae9be7a3145ccb84"><strong>RavenDB Migrations: Rolling Updates</strong></a></p> <p>Auch sehr interessant der Blogpost zu <a href="http://ayende.com/blog/66562/ravendb-migrations-when-to-execute?key=ce49237014234c44be9771c5064f0d01">Migrations</a>.</p> <p><strong>Aller Anfang ist schwer…</strong></p> <p>Definitiv ist bei NoSQL Datenbanken ein Umdenken erforderlich. So ganz klar und geheuer ist es mir ja noch nicht ganz, aber ich schau immer mal bei der RavenDB Demoapp <a href="https://github.com/ayende/RaccoonBlog">Raccoon Blog</a> wie der Schöpfer es da gemacht hat <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-winkingsmile" alt="Zwinkerndes Smiley" src="{{BASE_PATH}}/assets/wp-images/wlEmoticon-winkingsmile6.png"></p>
