---
layout: post
title: "Microsoft Account Login via ASP.NET Identity"
date: 2014-07-06 22:18
author: robert.muehsig
comments: true
categories: [HowTo]
tags: [HowTo, Microsoft Account]
---
{% include JB/setup %}
<p>Der Microsoft Account ist die zentrale Identifikationsstelle in der “Consumer-Microsoft-Welt”, allerdings ist das Einbinden eben dieser in die eigene Applikation eher schwierig. Das “Live SDK” ist nun unter dem OneDrive Dev Center zu finden und ganz professionell wurden auch alle Links zum alten Live SDK damit unbrauchbar gemacht. Beim Microsoft Account ist es auch unmöglich “localhost” als “Redirect”-URL anzugeben – alles Dinge die bei Twitter, Google und Facebook wesentlich einfacher sind. Naja – genug gelästert. Hier ein Weg wie es geht:</p> <h3>1. ASP.NET Anwendung (mit MVC) anlegen</h3> <p>Seitdem neuen Template gibt es auch ein neues Identity System, welches die Nutzung von Facebook, Twitter, Google und eben den Microsoft Account vereinfacht.</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image2028.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image_thumb1164.png" width="570" height="425"></a></p> <h3>2. Startup.Auth.cs orten</h3> <p>Wenn man die Auth-Einstellung auf “Individual User Accounts” lässt sollte man unter App_Start auch die “Startup.Auth.cs” finden. Dort muss man nur die entsprechende Zeile auskommentieren und entsprechend bestücken.</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image2029.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image_thumb1165.png" width="570" height="423"></a></p> <h3>3. Anwendung im Microsoft Account Dev Center anlegen</h3> <p><a href="{{BASE_PATH}}/assets/wp-images/image2030.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image_thumb1166.png" width="570" height="200"></a></p> <p>Im <a href="http://msdn.microsoft.com/en-us/onedrive/">OneDrive Dev Center</a> (ehemals Live Dev Center) kann man unter dem Punkt “Dashboard” seine Anwendungen pflegen. Dies ist so ziemlich dasselbe Vorgehen wie bei Twitter, Facebook und co.</p> <p>Das Anlegen der Anwendung ist relativ einfach, schwierigster Punkt ist diese Seite:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image2031.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image_thumb1167.png" width="570" height="470"></a></p> <p>Hier muss man als “Redirect” URL eine richtige URL eintragen – localhost geht nicht. Es gibt ein Workaround über den Dienst “localtest.me”. Hier an der Stelle kann man sich irgendeine URL überlegen und einfach eintragen und am Ende noch “signin-microsoft” eintragen. Ohne dies kommt nur eine seltsame Fehlermeldung (<u>die nur Sichtbar in der URL ist!).</u></p> <h3>4. ClientId und ClientSecret in der Startup.Auth.cs eintragen</h3> <p>Unter den Basic Information findet man die ClientId und das ClientSecret welches man in der Startup.Auth.cs nachtragen muss.</p> <h3>5. *.localtest.me aktivieren und im Projekt hinterlegen</h3> <p>Für mein Beispiel habe ich “blogpostsample.localtest.me” verwendet und die Idee hinter localtest.me könnt ihr am besten <a href="http://readme.localtest.me/">hier</a> nachlesen. Beim <a href="https://github.com/NuGet/NuGetGallery/blob/master/tools/Enable-LocalTestMe.ps1">NuGet Gallery Projekt</a> dasselbe Verfahren genutzt und daher habe ich auch das Powershell Script&nbsp; von da genommen. Das Script registriert im IIS Express die URL und danach kann diese URL auch in dem Visual Studio Projekt hinterlegt werden. Das angepasste Powershell Script ist am Ende natürlich auch bei GitHub zu finden. Das Script muss unter einer Admin-PS Shell ausgeführt werden:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image2032.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image_thumb1168.png" width="570" height="97"></a></p> <h3>6. Und läuft…</h3> <p>Nachdem man dies gemacht hat kann man sich anmelden (ich habe in dem Falle schon mein Account mit der Anwendung verknüpft – ansonsten würde nach der Anmeldung kommen “Die Anwendung möchte dies und jenes machen…”).</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image2033.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image_thumb1169.png" width="570" height="280"></a></p> <p>Danach die Anmeldung…</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image2034.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image_thumb1170.png" width="227" height="240"></a></p> <p>Und danach ist man angemeldet – läuft…</p> <h3>Und nun?</h3> <p>Jetzt ist man angemeldet und in der Theorie kann man nun mit dem eigentlichen Live SDK noch weitere Daten abrufen – aber für die pure Authentifizierung reicht das schon mal. Der <a href="http://www.benday.com/2014/02/25/walkthrough-asp-net-mvc-identity-with-microsoft-account-authentication/">Blogpost hier in englisch</a> hat mir bei der Redirect-URL weitergeholfen.</p> <p>Hier gehts zum <a href="https://github.com/Code-Inside/Samples/tree/master/2014/MicrosoftAccountDemo">Source Code auf GitHub</a>.</p>
