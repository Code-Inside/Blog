---
layout: post
title: "ASP.NET MVC Preview 2 + Membership"
date: 2008-03-13 21:59
author: robert.muehsig
comments: true
categories: [Allgemein]
tags: [ASP.NET MVC, ASP.NET MVC Preview, Membership]
---
{% include JB/setup %}
<p>Ich hab mich in den letzten 3 Tagen (jeweils vielleicht 1,5 Stunden)&#160; mit dem <a href="http://asp.net/MVC/">ASP.NET MVC (Preview 2)</a> besch&#228;ftigt.</p>  <p>Wer ASP.NET MVC mit dem Visual Web Developer ausprobieren m&#246;chte, der schaut sich am besten <a href="{{BASE_PATH}}/2007/12/16/erster-eindruck-von-aspnet-mvc-mit-dem-visual-web-developer-express/">diesen Blogpost</a> von mir an.</p>  <p>Wenn man das MVC Modell installiert hat, bekommt man eine neue Projektvorlage:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image322.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="138" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb301.png" width="233" border="0" /></a> </p>  <p>Wenn man dies nun das erste mal startet, erblickt man eine doch schon nett ausschauende Seite:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image323.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="213" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb302.png" width="464" border="0" /></a> </p>  <p>Leider kann man nur zwischen &quot;Home&quot; und &quot;About&quot; hin und her schalten.</p>  <p><strong><u>Ich will ein einfaches Loginsystem haben</u></strong></p>  <p>Grob hab ich &#228;hnliche Schritte wie <a href="{{BASE_PATH}}/2008/02/07/howto-aspnet-membership-roles-profiles-einrichten-rollensystem-allgemeines-demoprojekt/">hier</a> gemacht - also ASP.NET DB aufgesetzt, User eingetragen &amp; das Men&#252; erstmal erweitert (und die CSS etwas umgestellt) :</p>  <p><strong>Vorher:</strong></p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image324.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="62" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb303.png" width="191" border="0" /></a> </p>  <p><strong>Nachher:</strong></p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image325.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="42" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb304.png" width="244" border="0" /></a> </p>  <p>Der &quot;Login&quot; &amp; &quot;Register&quot; Button verweist auf den LoginController (die genaue Implementation findet ihr im Download) :</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image326.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="224" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb305.png" width="315" border="0" /></a>&#160; <br /><em>(das Attribut wird sp&#228;ter erkl&#228;rt)</em></p>  <p><strong><u>Im Login Userinterface sieht das so aus</u></strong>    <br /><u>&quot;Index.aspx&quot;</u></p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image327.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="183" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb306.png" width="244" border="0" /></a>&#160;</p>  <p><u>&quot;PasswordRecovery.aspx&quot;</u></p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image328.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="158" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb307.png" width="244" border="0" /></a>&#160; <br /><em>(nicht wundern: hier gibt man den Nutzernamen ein und das generierte Passwort wird hier wieder ausgegeben - in einer richtigen Applikation w&#252;rde man dies &#252;ber eine Email an den jeweiligen schicken)</em></p>  <p><u>&quot;Register.aspx&quot;</u></p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image329.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="179" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb308.png" width="244" border="0" /></a> </p>  <p>In der Dateistruktur ist es recht &#252;bersichtlich:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image330.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="80" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb309.png" width="203" border="0" /></a> </p>  <p><strong><u>Nach einem erfolgreichen Login</u></strong></p>  <p>Das Men&#252; wird entsprechend (&#252;ber das <a href="http://msdn2.microsoft.com/de-de/library/system.web.ui.webcontrols.loginview(VS.80).aspx">ASP.NET LoginView Control</a>) ver&#228;ndert:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image331.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="41" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb310.png" width="244" border="0" /></a> </p>  <p>Das Profil kann man auf dieser Seite ansehen:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image332.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="156" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb311.png" width="160" border="0" /></a> </p>  <p>... und editieren:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image333.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="172" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb312.png" width="244" border="0" /></a> </p>  <p>In der Dateistruktur:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image334.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="60" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb313.png" width="140" border="0" /></a> </p>  <p>... und der Controller:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image335.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="163" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb314.png" width="296" border="0" /></a> </p>  <p><strong><u>Rechtesystem mit Rollensystem</u></strong></p>  <p>Ich habe noch eine Adminrolle hinzugef&#252;gt, dieser kann User auf einer &#220;bersichtsseite wieder l&#246;schen und hat eine anderes Men&#252;:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image336.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="37" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb315.png" width="244" border="0" /></a> </p>  <p>Die Administrationsseite:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image337.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="119" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb316.png" width="328" border="0" /></a> </p>  <p>Der &quot;Delete&quot; link verweisst auf diese URL:</p>  <p>&quot;/Useradmin/Delete/[USERNAME]&quot;</p>  <p>Der Controller ist auch recht einfach:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image338.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="178" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb317.png" width="358" border="0" /></a> </p>  <p>Mit einem Klick auf den Link wird der Nutzer gel&#246;scht.</p>  <p><strong>Wie sieht das ganze Projekt aus?</strong></p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image339.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="499" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb318.png" width="210" border="0" /></a> </p>  <p>Das ist das gesamte Projekt - sieht auf dem ersten Blick viel aus, allerdings ist es einfach durch das MVC Paradigma eine solche Trennung zwischen den einzelnen Views. Die Views selbst sind meistens sehr schmal gehalten.</p>  <p><strong>Was machen diese Attribute &quot;RequiresRole&quot; &amp; &quot;RequiresAuthentication&quot;?</strong></p>  <p>In ASP.NET WebForms kann man &#252;ber die Web.config die Sicherheitsregeln einstellen. Das wird auf die entsprechende URL gemappt - da aber die URL im MVC nur noch wenig mit der richtigen Pfadangabe zutun hat, gibt es da nat&#252;rlich Probleme.</p>  <p>Abhilfe schaffen diese beiden Attribute, welche &#252;berpr&#252;fen, ob der Nutzer authentifiziert ist oder ob er in der angegebenen Rolle ist. Der Code daf&#252;r stammt von <a href="http://blog.wekeroad.com/2008/03/12/aspnet-mvc-securing-your-controller-actions/">Rob Conerys Blog</a>.</p>  <p><strong>Wie schickt man Daten an den Controller und wieder zur&#252;ck?</strong></p>  <p>Um mal ein Beispiel zu zeigen, wie einfach die Kommunikation zwischen den Controllern und den Viewpages ist, m&#246;chte ich die Register Methode im LoginController erkl&#228;ren:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image340.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="326" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb319.png" width="516" border="0" /></a> </p>  <p>Damit ich die Registrierseite unter der URL &quot;Login/Register&quot; erreichen kann, pr&#252;fe ich im ersten Schritt, ob ich bereits irgendwelche Daten in dem Request stehen.</p>  <p><u>Wenn ja:</u></p>  <p>Verarbeite die Daten - also bef&#252;lle das Membership System. Wenns ein Fehler gibt (z.B. der Nutzer existiert bereits), dann merke dir in &quot;ViewData&quot;, dass ein Fehler aufgetreten ist und render den View.   <br />Die Membership API ist in diesem Fall unser Model - das wir entsprechend bef&#252;llen.</p>  <p><u>Wenn nein:</u></p>  <p>Render den View   <br /></p>  <p>Im View ist sehr einfaches HTML - keine runat=&quot;server&quot; etc.    <br /></p>  <p><u>Hinweis:</u> Scott Guthrie hat dieses Thema bereits <a href="http://weblogs.asp.net/scottgu/archive/2007/12/09/asp-net-mvc-framework-part-4-handling-form-edit-and-post-scenarios.aspx">vor einige Zeit</a> gut erkl&#228;rt.</p>  <p><strong>Erweitertes Beispiel ist fertig.</strong></p>  <p>Man kann sich bei der Demoapplikation nun Anmelden, Registrieren, ein neues Passwort generieren lassen wenn es vergessen wurde, seine Hauptdaten &#228;ndern und der Admin kann Nutzer l&#246;schen - ich denke f&#252;r einen ersten Wurf ist das eigentlich schon ok :)</p>  <p>Unten findet ihr diese Applikation zum Runterladen und selber ausprobieren. Wichtig ist, dass ihr die ASP.NET MVC Preview 2 installiert habt.</p>  <p>An die Kritiker, die meinen, dass man das mit den eingebauten ASP.NET Controls viel schneller hinbekommt: Das mag erstmal hier vielleicht stimmen - allerdings sind die Controls verdammt umst&#228;ndlich, wenn man die etwas ver&#228;ndern m&#246;chte oder ganz einfache Funktionalit&#228;t einbauen m&#246;chte.   <br />Im Zusammenhang mit einer Masterpage (und vielleicht wenn man das <a href="http://www.aspnetzone.de/blogs/peterbucher/archive/2007/07/11/login-control-aussehen-und-output-per-template-anpassen.aspx">Logincontrol noch ab&#228;ndert</a>), funktioniert die &quot;Enter&quot; Taste nicht mehr - das muss man erst <a href="http://weblogs.asp.net/jgalloway/archive/2007/10/03/asp-net-setting-the-defaultbutton-for-a-login-control.aspx">recht komplex umstellen</a>. Das ganze ist recht fix implementiert gewesen - die Geschwindigkeit (und die nette Logik) mit der man entwickelt empfinge ich als ex-PHP Entwickler wesentlich logischer, als dieses Postback Modell.</p>  <p>Wer auf pures HTML steht (dazu z&#228;hle ich mich) und diese Servercontrols f&#252;r den &quot;falschen&quot; Weg h&#228;lt, der sollte sich das Beispiel hier mal anschauen. Ich gebe zu, dass der Inlinecode sicherlich auch noch nicht ganz der Weisheit letzter Schluss ist, allerdings ist eine ViewPage auch nichts anderes als eine Klasse, welche ein Konstruktor hat - wenn man dies alles noch mit kleinen Methoden und/oder UserControls auslagert, ist das MVC Model f&#252;r viele F&#228;lle sicher auch eine ebenso gute Wahl.</p>  <p><strong>Letzter Hinweis:</strong> </p>  <p>Das ist eine Demoapplikation - wer sich n&#228;her mit dem MVC Modell besch&#228;ftigt, wird bestimmt noch viele weitere coole Features finden.</p>  <p><strong><a href="http://{{BASE_PATH}}/assets/files/democode/mvc2membership/mvc2.zip">[ Download Democode ]*</a></strong></p>  <p>* in der ReadMe.txt stehen die Logindaten f&#252;r das Beispiel</p>  <p><strong>Empfohlene Links:</strong></p>  <p>Die Videos von Scott Hanselman zu <a href="http://asp.net/MVC/">ASP.NET MVC</a> sowie die <a href="http://www.hanselman.com/blog/ASPNETMVCCheesyNorthwindSampleCode.aspx">Northwind Sample App</a> sollte man sich auch anschauen.</p>
